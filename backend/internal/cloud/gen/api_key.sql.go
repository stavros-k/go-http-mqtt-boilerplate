// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: api_key.sql

package clouddb

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const createAPIKey = `-- name: CreateAPIKey :one
INSERT INTO "api_key" (
    key_hash,
    name,
    user_id,
    permissions,
    expires_at,
    created_at,
    updated_at
  )
VALUES ($1, $2, $3, $4, $5, $6, $7)
RETURNING id, key_hash, name, user_id, permissions, last_used, expires_at, revoked, created_at, updated_at
`

type CreateAPIKeyParams struct {
	KeyHash     string
	Name        string
	UserID      int32
	Permissions []byte
	ExpiresAt   pgtype.Timestamp
	CreatedAt   pgtype.Timestamp
	UpdatedAt   pgtype.Timestamp
}

// CreateAPIKey
//
//	INSERT INTO "api_key" (
//	    key_hash,
//	    name,
//	    user_id,
//	    permissions,
//	    expires_at,
//	    created_at,
//	    updated_at
//	  )
//	VALUES ($1, $2, $3, $4, $5, $6, $7)
//	RETURNING id, key_hash, name, user_id, permissions, last_used, expires_at, revoked, created_at, updated_at
func (q *Queries) CreateAPIKey(ctx context.Context, arg CreateAPIKeyParams) (ApiKey, error) {
	row := q.db.QueryRow(ctx, createAPIKey,
		arg.KeyHash,
		arg.Name,
		arg.UserID,
		arg.Permissions,
		arg.ExpiresAt,
		arg.CreatedAt,
		arg.UpdatedAt,
	)
	var i ApiKey
	err := row.Scan(
		&i.ID,
		&i.KeyHash,
		&i.Name,
		&i.UserID,
		&i.Permissions,
		&i.LastUsed,
		&i.ExpiresAt,
		&i.Revoked,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const deleteAPIKey = `-- name: DeleteAPIKey :exec
DELETE FROM "api_key"
WHERE key_hash = $1
`

type DeleteAPIKeyParams struct {
	KeyHash string
}

// DeleteAPIKey
//
//	DELETE FROM "api_key"
//	WHERE key_hash = $1
func (q *Queries) DeleteAPIKey(ctx context.Context, arg DeleteAPIKeyParams) error {
	_, err := q.db.Exec(ctx, deleteAPIKey, arg.KeyHash)
	return err
}

const getAPIKey = `-- name: GetAPIKey :one
SELECT id, key_hash, name, user_id, permissions, last_used, expires_at, revoked, created_at, updated_at FROM "api_key"
WHERE key_hash = $1 AND revoked = false LIMIT 1
`

type GetAPIKeyParams struct {
	KeyHash string
}

// GetAPIKey
//
//	SELECT id, key_hash, name, user_id, permissions, last_used, expires_at, revoked, created_at, updated_at FROM "api_key"
//	WHERE key_hash = $1 AND revoked = false LIMIT 1
func (q *Queries) GetAPIKey(ctx context.Context, arg GetAPIKeyParams) (ApiKey, error) {
	row := q.db.QueryRow(ctx, getAPIKey, arg.KeyHash)
	var i ApiKey
	err := row.Scan(
		&i.ID,
		&i.KeyHash,
		&i.Name,
		&i.UserID,
		&i.Permissions,
		&i.LastUsed,
		&i.ExpiresAt,
		&i.Revoked,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const listAPIKeysByUser = `-- name: ListAPIKeysByUser :many
SELECT id, key_hash, name, user_id, permissions, last_used, expires_at, revoked, created_at, updated_at FROM "api_key"
WHERE user_id = $1 AND revoked = false
ORDER BY created_at DESC
`

type ListAPIKeysByUserParams struct {
	UserID int32
}

// ListAPIKeysByUser
//
//	SELECT id, key_hash, name, user_id, permissions, last_used, expires_at, revoked, created_at, updated_at FROM "api_key"
//	WHERE user_id = $1 AND revoked = false
//	ORDER BY created_at DESC
func (q *Queries) ListAPIKeysByUser(ctx context.Context, arg ListAPIKeysByUserParams) ([]ApiKey, error) {
	rows, err := q.db.Query(ctx, listAPIKeysByUser, arg.UserID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []ApiKey{}
	for rows.Next() {
		var i ApiKey
		if err := rows.Scan(
			&i.ID,
			&i.KeyHash,
			&i.Name,
			&i.UserID,
			&i.Permissions,
			&i.LastUsed,
			&i.ExpiresAt,
			&i.Revoked,
			&i.CreatedAt,
			&i.UpdatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const revokeAPIKey = `-- name: RevokeAPIKey :exec
UPDATE "api_key"
SET revoked = true, updated_at = $2
WHERE key_hash = $1
`

type RevokeAPIKeyParams struct {
	KeyHash   string
	UpdatedAt pgtype.Timestamp
}

// RevokeAPIKey
//
//	UPDATE "api_key"
//	SET revoked = true, updated_at = $2
//	WHERE key_hash = $1
func (q *Queries) RevokeAPIKey(ctx context.Context, arg RevokeAPIKeyParams) error {
	_, err := q.db.Exec(ctx, revokeAPIKey, arg.KeyHash, arg.UpdatedAt)
	return err
}

const updateAPIKeyLastUsed = `-- name: UpdateAPIKeyLastUsed :exec
UPDATE "api_key"
SET last_used = $2, updated_at = $3
WHERE key_hash = $1
`

type UpdateAPIKeyLastUsedParams struct {
	KeyHash   string
	LastUsed  pgtype.Timestamp
	UpdatedAt pgtype.Timestamp
}

// UpdateAPIKeyLastUsed
//
//	UPDATE "api_key"
//	SET last_used = $2, updated_at = $3
//	WHERE key_hash = $1
func (q *Queries) UpdateAPIKeyLastUsed(ctx context.Context, arg UpdateAPIKeyLastUsedParams) error {
	_, err := q.db.Exec(ctx, updateAPIKeyLastUsed, arg.KeyHash, arg.LastUsed, arg.UpdatedAt)
	return err
}
